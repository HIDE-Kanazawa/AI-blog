# Vibe CodingブログMVP：要件定義＋設計ドラフト

> 目的：ひでさん自身が「朝5:00にAIニュースを収集 → 噛み砕き解説」を**完全自動公開**する最小構成（MVP）。不要機能は入れない。

---

## 0. スコープ（MVP）

* **読者＝自分**。管理UIでは「テーマ/キーワード/ソース」を設定できること。
* ソースは2系統：

  1. **登録済み情報源**（主にYouTubeチャンネル）
  2. **任意キーワードでのWeb検索**（Google Programmable Search API＝CSEを想定）
* 毎日 **05:00 JST** に実行、**完全自動公開**。
* 記事は**日本語**のみ。トーンは「最新技術を初心者にもわかりやすく」。
* 生成は **Claude 4 系 API** を使用。**ステップ分割**で安定化。
* **ファクトチェック・出典表示は省略**（MVP方針）。ただし内部的に参照URLを保持（トラブル時の追跡用）。
* サムネイルは**自動生成**（MVPでは動的OG画像＝自動カード生成で代替）。

---

## 1. システム全体像（MVPアーキテクチャ）

```
[Vercel Cron 05:00] ─▶ [/api/cron/run]
  └─▶ Fetch Sources (YouTube API / Google CSE)
       └─▶ Normalize (title, url, publishedAt, snippet)
            └─▶ Select Top-N (去重/新規のみ)
                 └─▶ Claude Pipeline (抽出→構成→本文)
                      └─▶ Generate OGP (動的画像)
                           └─▶ Save to Sanity (draft/approved=auto)
                                └─▶ Revalidate/ISR & Publish
```

* 実行は **Vercel Functions**（EdgeでなくNodeランタイム推奨：Claude/YouTube/Google API互換性のため）。
* データ保存/管理は **Sanity**（Content Lake）。
* フロントは **Next.js on Vercel**（ISR中心）。

---

## 2. データモデル（Sanity スキーマ最小セット）

### 2.1 `sourceFeed`

* 目的：情報源の登録。完全自動化に必要最小限。
* フィールド：

  * `type`: `"youtube" | "search"`（固定）
  * `label`: 表示名
  * `channelId` （type=youtubeの時）
  * `query` （type=searchの時：検索キーワード）
  * `active`: boolean
  * `limitPerRun`: number（1回のジョブで最大取得件数。MVP既定=3）

### 2.2 `post`

* 目的：公開記事。
* フィールド：

  * `title`, `slug`, `summary`, `body` (rich text/portable text)
  * `heroOgStyle`: `"auto"`（MVP：動的OGのスタイルプリセット）
  * `topic`: `"ai-news"` 固定
  * `sources`: array<reference/URL string>（**内部保持**：出典URLの配列）
  * `publishAt`: datetime（自動）
  * `aiMeta`: object { model, tokensIn, tokensOut, costJPY, promptHash }
  * `status`: `"published" | "failed"`（MVPは基本published）

### 2.3 `jobRun`

* 目的：実行ログ。
* フィールド：

  * `startedAt`, `finishedAt`, `status` (`"ok"|"error"`)
  * `pickedItems`: number（採用件数）
  * `errorMessage`（失敗時）

> **非搭載（MVP外）**：ユーザー管理、レビュー承認、タグ、シリーズ等

---

## 3. 環境変数（Vercel / Sanity Secrets）

* `ANTHROPIC_API_KEY`（Claude 4）
* `GOOGLE_API_KEY`（CSE用）
* `GOOGLE_CSE_ID`（cx）
* `YOUTUBE_API_KEY`
* `SANITY_PROJECT_ID`, `SANITY_DATASET`, `SANITY_WRITE_TOKEN`

---

## 4. パイプライン詳細（ステップ分割）

### 4.1 収集

* **YouTube**：`search.list` で channelId の最新動画を取得（title, url, publishedAt, description 一部）。
* **Search**（Google CSE）：queryごとに 上位N件（ニュース/ウェブ）を取得。
* **去重/新規判定**：URLのハッシュ or `publishedAt` + `url` の複合キーで Sanity に既存照合。

### 4.2 整形・選別

* 各アイテムを `contextItem = {title, url, snippet, publishedAt}` に正規化。
* 1ランにつき **最大3件** 採用（`limitPerRun`総和を上限、MVP既定=3）。

### 4.3 生成（Claude 4）

* **ステップ1: 抽出**

  * 入力：contextItems（最大3件、各要旨300〜500字）
  * 出力：要点（箇条書き5点以内）、初学者に必要な前提用語リスト
* **ステップ2: 構成**

  * 入力：要点/用語
  * 出力：見出し構成（H2/H3）と各見出しの要旨
* **ステップ3: 本文**

  * 入力：構成
  * 出力：本文（約800〜1200字、やさしい日本語、比喩少なめ、例示1つ）
  * 注意：**出典リンクは本文に出さない**（MVP方針）。
* **ステップ4: 要約/スニペット**

  * 出力：`summary`（120〜160字、メタディスクリプション兼用）

> 生成後、`sources[]` に内部保持（本文には未表示）。

### 4.4 OGP/サムネ

* MVPは **動的OG画像**（/api/og?title=...）。

  * タイトル、日付「JST 05:00」、固定テーマ「AI NEWS」。
  * 後日、画像生成API（例：Playwright+HTML to PNG / 画像モデル）に差し替え可。

### 4.5 永続化 & 公開

* Sanity へ `post` 作成（`status=published`）。
* Next.js の ISR 再検証（/, /posts/[slug]）。

### 4.6 失敗時

* `jobRun` に `status=error` + `errorMessage` 保存。
* （MVPでは通知なし。将来Slack/メール追加）

---

## 5. Next.js（App Router）最低限構成

```
/app
  /page.tsx                # 最新記事一覧（10件）
  /posts/[slug]/page.tsx   # 記事詳細（PortableTextレンダ）
  /about/page.tsx          # 簡易プロフィール
  /api/cron/run/route.ts   # Vercel Cronエントリ（05:00）
  /api/pipeline/run/route.ts   # 手動実行用（開発中のみ）
  /api/og/route.ts         # 動的OG画像
/lib
  /sanity.ts               # client 初期化
  /fetch/youtube.ts        # YouTube取得
  /fetch/search.ts         # Google CSE取得
  /ai/claude.ts            # Anthropic SDK呼び出し（分割実行）
  /pipeline.ts             # 収集→生成→保存 一括
  /slug.ts                 # スラッグ生成ユーティリティ
  /hash.ts                 # URLハッシュ/去重
  /date.ts                 # JST整形
/sanity
  /schemas/index.ts
  /schemas/post.ts
  /schemas/sourceFeed.ts
  /schemas/jobRun.ts
```

* **ランタイム**：`export const runtime = "nodejs";`（Claude等で必須）
* **公開フロー**：cron→run（自動）

---

## 6. Sanity スキーマ（TypeScript）

> **MVP最小**。カスタム入力/UIは付けない。

```ts
// /sanity/schemas/sourceFeed.ts
import { defineType, defineField } from "sanity";
export default defineType({
  name: "sourceFeed",
  title: "Source Feed",
  type: "document",
  fields: [
    defineField({ name: "type", type: "string", options: { list: ["youtube", "search"] }, validation: r => r.required() }),
    defineField({ name: "label", type: "string", validation: r => r.required() }),
    defineField({ name: "channelId", type: "string", hidden: ({ parent }) => parent?.type !== "youtube" }),
    defineField({ name: "query", type: "string", hidden: ({ parent }) => parent?.type !== "search" }),
    defineField({ name: "active", type: "boolean", initialValue: true }),
    defineField({ name: "limitPerRun", type: "number", initialValue: 3 }),
  ],
});
```

```ts
// /sanity/schemas/post.ts
import { defineType, defineField } from "sanity";
export default defineType({
  name: "post",
  title: "Post",
  type: "document",
  fields: [
    defineField({ name: "title", type: "string", validation: r => r.required() }),
    defineField({ name: "slug", type: "slug", options: { source: "title" } }),
    defineField({ name: "summary", type: "text" }),
    defineField({ name: "body", type: "array", of: [{ type: "block" }] }),
    defineField({ name: "heroOgStyle", type: "string", initialValue: "auto" }),
    defineField({ name: "topic", type: "string", initialValue: "ai-news" }),
    defineField({ name: "sources", type: "array", of: [{ type: "url" }] }), // 本文非表示
    defineField({ name: "publishAt", type: "datetime" }),
    defineField({ name: "aiMeta", type: "object", fields: [
      { name: "model", type: "string" },
      { name: "tokensIn", type: "number" },
      { name: "tokensOut", type: "number" },
      { name: "costJPY", type: "number" },
      { name: "promptHash", type: "string" },
    ]}),
    defineField({ name: "status", type: "string", options: { list: ["published", "failed"] }, initialValue: "published" }),
  ],
});
```

```ts
// /sanity/schemas/jobRun.ts
import { defineType, defineField } from "sanity";
export default defineType({
  name: "jobRun",
  title: "Job Run",
  type: "document",
  fields: [
    defineField({ name: "startedAt", type: "datetime" }),
    defineField({ name: "finishedAt", type: "datetime" }),
    defineField({ name: "status", type: "string", options: { list: ["ok", "error"] } }),
    defineField({ name: "pickedItems", type: "number" }),
    defineField({ name: "errorMessage", type: "text" }),
  ],
});
```

```ts
// /sanity/schemas/index.ts
import post from "./post";
import sourceFeed from "./sourceFeed";
import jobRun from "./jobRun";
export const schemaTypes = [post, sourceFeed, jobRun];
```

---

## 7. パイプライン擬似コード（最小）

```ts
// /lib/pipeline.ts
export async function runPipeline() {
  const startedAt = new Date();
  const feeds = await getActiveFeeds(); // Sanity fetch
  const items = await collectItems(feeds); // YouTube & CSE
  const fresh = await filterNew(items);   // 去重
  const picked = pickTopN(fresh, 3);      // 1ラン3件

  if (picked.length === 0) return await logRun({ startedAt, status: 'ok', pickedItems: 0 });

  const context = picked.map(miniSummarize); // 1件あたり300-500字
  const outline = await claudeOutline(context); // ステップ2
  const body    = await claudeArticle(outline); // ステップ3
  const summary = await claudeMeta(body);       // ステップ4

  await createPost({ title: outline.title, body, summary, sources: picked.map(p=>p.url) });
  await revalidateISR(['/','/posts/'+slug]);

  return await logRun({ startedAt, status: 'ok', pickedItems: picked.length });
}
```

---

## 8. プロンプト骨子（Claude 4, 日本語）

### (1) 抽出

* システム：

  * 役割：**AIニュース編集者**。初心者にわかる言葉で要点のみ抽出。
  * 制約：誇張・推測禁止。専門用語は短い説明を添える。
* ユーザー：

  * 入力：`[{title, snippet, publishedAt, url}] x ≤3`
  * 出力：

    * 要点（最大5項目）
    * 前提用語の簡易解説（最大5語）

### (2) 構成

* 目的：H2/H3 と各節の要旨（1-2文）
* 注意：導入150字、結論100字。

### (3) 本文

* 目的：800-1200字。例え話1つ。箇条書き活用。
* 禁則：出典リンクの記載はしない。断定を避け、**「可能性/見込み」表現**に統一。

### (4) 要約

* 目的：120-160字のメタ説明。初心者の検索意図を満たす1文。

---

## 9. ルーティング & Cron

* **Vercel Cron**（JST 05:00 → UTCに変換して設定）

  * `vercel.json` 例：

```json
{
  "crons": [
    { "path": "/api/cron/run", "schedule": "0 20 * * *" }
  ]
}
```

> JST 05:00 は UTC 20:00（前日）

---

## 10. SEO/表示（MVP）

* `/`：最新10件、カードはタイトル＋要約＋日時。
* `/posts/[slug]`：本文＋自動OG、**出典UIは非表示**。
* メタ：`title`, `description` を`summary`から生成。`canonical`はサイトルート基準。
* サイトマップは後回し（MVP外）。

---

## 11. コンプライアンスの軽量ガード（MVPでも最小限）

* **コピー＆ペースト禁止**：生成プロンプトで「逐語引用しない」を明示。
* **出典URLは内部保持のみ**：万一の問い合わせ対応に使用。
* **画像**：MVPは動的OG（自作扱い）。外部画像の直リンクはしない。

---

## 12. 予算と上限

* 目標PV：**500/月**（アフィ審査目安超え）。
* コスト目安（MVP）：

  * Vercel Hobby（無料枠内想定）
  * Sanity Free（月間API/帯域内）
  * Claude 4：1日1本×3ステップ＝数十円/日 見込み（実測で最適化）
  * YouTube/CSE：無料枠内/少額
* `jobRun` に `costJPY` を記録し、月次合計は別途集計（後日）

---

## 13. リスク（明示）

* **無出典公開**：誤情報時の信頼低下。→ 文体を「解説」基調・断定回避。
* **トピック鮮度**：05:00固定で取り逃しの可能性。→ 手動`/api/pipeline/run`も用意。
* **API制限**：CSEの日次クォータ。→ キーワード件数を絞る/`limitPerRun`で調整。

---

## 14. 次アクション（ひでさん確認事項）

1. **YouTubeチャンネルID** と **検索キーワード** の初期セット（3〜5件）
2. Sanity プロジェクトID/データセット名の確定
3. ドメイン（例：vibecoding.dev） or Vercel一旦デフォルト
4. OGPのカードデザイン（背景グラデ or 無地）

→ 確定後、**初期リポジトリ雛形（Next.js + Sanity + API配線）** を作成します。
